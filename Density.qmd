---
title: "DensityAnalysisCapstone"
format: html
editor: visual
---

```{r}
pkg <- c("lme4", "lmerTest", "emmeans", "rstatix", "dplyr", "ggplot2", "readxl",
"boot", "car", "MASS", "ggpubr", "patchwork", "gridExtra", "performance", "tidyverse", "forcats")

new_pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
if (length(new_pkg)) install.packages(new_pkg)
lapply(pkg, library, character.only = TRUE)
```

$$
\text{lmer}\big(\log(\text{Density}) \sim \text{Plot} + (1 \mid \text{Location}),\ \text{data} = \text{capstone}\big)
$$

$$
\log(\text{Density}_{ijk}) = \beta_0 + \beta_{1j} + u_k + \epsilon_{ijk}
$$

$\log(\text{Density}_{ijk})$ = log-transformed tree density (dependent variable)\
$\beta_0$ = fixed intercept (mean log-density for the reference Plot category, Edge)\
$\beta_{1j}$ = fixed effect of Plot $j$ (difference in mean log-density for Transition and Interior compared to Edge)\
$u_k \sim N(0, \sigma_{\text{Location}}^2)$ = random intercept for Location, capturing variability among locations\
$\epsilon_{ijk} \sim N(0, \sigma^2)$ = residual error for individual plots

$$
u_k \sim N(0, \sigma_{\text{Location}}^2), \quad \epsilon_{ijk} \sim N(0, \sigma^2)
$$

Where:

$\sigma_{\text{Location}}^2$ is the variance component due to Location (between-site variability), and\
$\sigma^2$ is the residual variance component (within-site, unexplained variability).

```{r}
file_path <- "C:/Users/Nicho/OneDrive/Desktop/Density.xlsx"
capstone <- read_excel(file_path, sheet = "Sheet1")

capstone <- capstone %>%
  mutate(

    Plot = as.character(Plot),
    Plot = case_when(
      Plot %in% c("1", "Edge") ~ "Edge",
      Plot %in% c("2", "Transition") ~ "Transition",
      Plot %in% c("3", "Interior") ~ "Interior",
      TRUE ~ NA_character_
    ),
    Plot = factor(Plot, levels = c("Edge", "Transition", "Interior")),

    Location = as.factor(Location),

    density_ha = density * 2.47105,

    log_density = log(density_ha)
  )

summary(capstone$log_density)
unique(capstone$Plot)
```

```{r}
location_order <- c(
  "Gardiner County Park",
  "Shinnecock",
  "Haven Point",
  "Ludlow Creek",
  "Pine Neck",
  "Wertheim",
  "Seatuck"
)

capstone$Location <- factor(capstone$Location, levels = location_order)

plot_box <- ggplot(capstone, aes(x = Location, y = log_density)) +
  stat_boxplot(geom = "errorbar", width = 0.5, linewidth = 0.3) +
  geom_boxplot(
    fill = "#82B1B1",
    color = "black",
    linewidth = 0.5,
    outlier.size = 1.5,
    outlier.shape = 1
  ) +
  labs(
    x = "Location",
    y = expression("Log Tree Density" ~ (log(stems/ha)))
  ) +
  coord_flip() +
  theme_bw() +
  theme(
    text = element_text(family = "sans", size = 12),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5),
    axis.text.x = element_text(
      angle = 30,
      hjust = 1,
      vjust = 1,
      color = "black"
    ),
    axis.text.y = element_text(color = "black"),
    axis.title.x = element_text(margin = margin(t = 10))
  )

print(plot_box)
```

```{r}
density_model <- lmer(
  log_density ~ Plot + (1 | Location),
  data = capstone
)

summary(density_model)

anova(density_model)
```

```{r}
density_tukey <- emmeans(density_model, pairwise ~ Plot, adjust = "tukey")
summary(density_tukey)
```

```{r}
back_means <- emmeans(density_model, ~ Plot)
bt_summary <- summary(back_means) %>%
  mutate(
    emmean_bt = exp(emmean),
    lower_bt  = exp(lower.CL),
    upper_bt  = exp(upper.CL)
  )

print(bt_summary)

bt_contrasts <- pairs(back_means, adjust = "tukey") %>%
  summary() %>%
  mutate(ratio = exp(estimate))

print(bt_contrasts)
```

```{r}
custom_colors <- c("Edge" = "#E69F00",
                   "Transition" = "#56B4E9",
                   "Interior" = "#009E73")

ggplot(bt_summary, aes(x = Plot, y = emmean_bt, color = Plot)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower_bt, ymax = upper_bt),
                width = 0.1, linewidth = 0.8) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Plot Type",
    y = expression("Estimated Mean Tree Density (stems / ha)")
  ) +
  theme_bw(base_size = 13) +
  theme(
    legend.position = "none",
    axis.text = element_text(color = "black"),
    axis.title = element_text(color = "black", face = "bold")
  )
```

```{r}
capstone <- capstone %>%
  mutate(

    Plot = as.character(Plot),
    Plot = case_when(
      Plot %in% c("1", "Edge") ~ "Edge",
      Plot %in% c("2", "Transition") ~ "Transition",
      Plot %in% c("3", "Interior") ~ "Interior",
      TRUE ~ NA_character_
    ),
    Plot = factor(Plot, levels = c("Edge", "Transition", "Interior")),

    density_ha = density * 2.47105,

    log_density = log(density_ha)
  )

custom_colors <- c(
  "Edge" = "#E69F00", 
  "Transition" = "#56B4E9", 
  "Interior" = "#009E73"
)

Figure_S7 <- ggplot(capstone, aes(x = Plot, y = log_density, fill = Plot)) +
  geom_boxplot(
    color = "black",
    width = 0.6,
    outlier.shape = NA,
    alpha = 0.9
  ) +
  geom_jitter(
    width = 0.1,
    size = 1.8,
    alpha = 0.8
  ) +
  scale_fill_manual(values = custom_colors, name = "Plot Type") +
  labs(
    x = "Plot Type",
    y = expression(ln(Tree~Density)~"(stems / ha)"),
    title = ""
  ) +
  theme_bw(base_size = 13) +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text = element_text(color = "black"),
    axis.title = element_text(color = "black", face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

print(Figure_S7)
```

```{r}
lmm_log_density <- lmer(log_density ~ Plot + (1 | Location), data = capstone)

diag_color <- "#56B4E9"
diag_point_color <- "darkblue"

hist2 <- ggplot(data.frame(res = residuals(lmm_log_density)), aes(x = res)) +
  geom_histogram(binwidth = 0.25, fill = diag_color, color = "black") +
  labs(
    title = "A) Log-Transformed Density Per Hectare LMM Residuals (Histogram)",
    x = "Residuals (log(stems per hectare))",
    y = "Frequency"
  ) +
  theme_bw(base_size = 12)

print(hist2)

qq2 <- ggplot(data.frame(res = residuals(lmm_log_density)), aes(sample = res)) +
  stat_qq(color = diag_point_color) +
  stat_qq_line(color = "red", linewidth = 0.8) +
  labs(
    title = "B) Log-Transformed Density Per Hectare LMM Residuals (Q-Q)",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_bw(base_size = 12)

print(qq2)

res_fit2 <- ggplot(data.frame(
  Fitted = fitted(lmm_log_density),
  Residuals = residuals(lmm_log_density)
), aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.6, color = diag_point_color) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(method = "loess", se = FALSE, color = diag_color, linewidth = 0.8) +
  labs(
    title = "C) Log-Transformed Density Per Hectare LMM Residuals vs. Fitted Values",
    x = expression("Fitted Values"~(ln(Density~(stems~per~hectare)))),
    y = "Residuals"
  ) +
  theme_bw(base_size = 12)

print(res_fit2)
```

```{r}
lmm_raw_density <- lmer(density * 2.47105 ~ Plot + (1 | Location), data = capstone)

diag_color <- "#F8766D"
diag_point_color <- "#F8766D"

res_raw <- residuals(lmm_raw_density)
fit_raw <- fitted(lmm_raw_density)

hist1_raw <- ggplot(data.frame(res = res_raw), aes(x = res)) +
  geom_histogram(
    binwidth = diff(range(res_raw)) / 20, 
    fill = diag_color, color = "black"
  ) +
  labs(
    title = "A) Untransformed Density Per Hectare LMM Residuals (Histogram)",
    x = "Residuals (stems per hectare)",
    y = "Frequency"
  ) +
  theme_bw(base_size = 12)

print(hist1_raw)

qq1_raw <- ggplot(data.frame(res = res_raw), aes(sample = res)) +
  stat_qq(color = diag_point_color) +
  stat_qq_line(color = "darkblue", linewidth = 0.8) +
  labs(
    title = "B) Untransformed Density Per Hectare LMM Residuals (Q-Q)",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_bw(base_size = 12)

print(qq1_raw)

res_fit1_raw <- ggplot(data.frame(Fitted = fit_raw, Residuals = res_raw),
                       aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.6, color = diag_point_color) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(method = "loess", se = FALSE, color = "darkblue", linewidth = 0.8) +
  labs(
    title = "C) Untransformed Density Per Hectare LMM Residuals vs Fitted Values",
    x = "Fitted Values (Density per hectare)",
    y = "Residuals"
  ) +
  theme_bw(base_size = 12)

print(res_fit1_raw)
```

```{r}
file_path <- "C:/Users/Nicho/OneDrive/Desktop/Density.xlsx"
capstone <- read_excel(file_path, sheet = "Sheet1")

capstone <- capstone %>%
  mutate(
    Location = as.factor(Location),
    Plot = as.factor(Plot),
    density_per_hectare = density * 2.47105,
    log_density = log(density_per_hectare)
  )

location_order <- c(
  "Gardiner County Park", "Shinnecock", "Haven Point",
  "Ludlow Creek", "Pine Neck", "Wertheim", "Seatuck"
)
capstone$Location <- fct_relevel(capstone$Location, location_order)

capstone <- capstone %>%
  mutate(Plot_Label = dplyr::recode(as.character(Plot),
                                    "1" = "Edge",
                                    "2" = "Transition",
                                    "3" = "Interior")) %>%
  mutate(Plot_Label = factor(Plot_Label,
                             levels = c("Edge", "Transition", "Interior")))

pal_plot <- c("Edge" = "#E69F00", "Transition" = "#56B4E9", "Interior" = "#009E73")

plot_points <- ggplot(capstone, aes(x = log_density, y = Location, color = Plot_Label)) +
  geom_point(position = position_jitterdodge(jitter.width = 0.05, dodge.width = 0.6),
             size = 3, alpha = 0.9) +
  scale_color_manual(values = pal_plot, name = "Plot Type") +
  labs(
    x = "Log Tree Density (log(stems per hectare))",
    y = "Location"
  ) +
  theme_bw(base_size = 13) +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10))
  )
print(plot_points)

density_model <- lmer(log_density ~ Plot + (1 | Location), data = capstone) 

density_tukey <- emmeans(density_model, pairwise ~ Plot, adjust = "tukey")
print(summary(density_tukey))

back_transformed_means <- emmeans(density_model, ~ Plot, type = "response")
bt_summary <- summary(back_transformed_means)
print(bt_summary)

em_df <- as.data.frame(bt_summary)
em_df$Plot_Label <- factor(dplyr::recode(as.character(em_df$Plot), "1" = "Edge", "2" = "Transition", "3" = "Interior"), levels = c("Edge", "Transition", "Interior"))
em_df_bt <- em_df %>%
  mutate(
    emmean_bt = exp(emmean),
    lower_bt  = exp(lower.CL),
    upper_bt  = exp(upper.CL)
  )

p_log <- ggplot(em_df_bt, aes(x = Plot_Label, y = emmean, color = Plot_Label)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.12, linewidth = 0.6) +
  scale_color_manual(values = pal_plot) +
  labs(
    x = "Plot Type",
    y = "Estimated Marginal Mean (log density)"
  ) +
  theme_bw(base_size = 13) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(size = 11),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.margin = margin(t = 10, r = 18, b = 10, l = 18)
  )
print(p_log)

p_bt <- ggplot(em_df_bt, aes(x = Plot_Label, y = emmean_bt, color = Plot_Label)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower_bt, ymax = upper_bt), width = 0.12, linewidth = 0.6) +
  scale_color_manual(values = pal_plot) +
  labs(
    x = "Plot Type",
    y = "Estimated Marginal Mean Density (trees per hectare)"
  ) +
  theme_bw(base_size = 13) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(size = 11),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.margin = margin(t = 10, r = 18, b = 10, l = 18)
  )
print(p_bt)
```
